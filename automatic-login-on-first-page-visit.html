<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Automatic login on first page visit | Social Playlist</title>
    <meta name="description" content="Springboot &amp; Angular Hands-on Workshop">
    
    
    <link rel="preload" href="/social-playlist/assets/css/0.styles.a5234e6a.css" as="style"><link rel="preload" href="/social-playlist/assets/js/app.41029deb.js" as="script"><link rel="preload" href="/social-playlist/assets/js/2.5ad4ca2f.js" as="script"><link rel="preload" href="/social-playlist/assets/js/7.1936ba72.js" as="script"><link rel="prefetch" href="/social-playlist/assets/js/10.9a624b33.js"><link rel="prefetch" href="/social-playlist/assets/js/11.b7ea0b1a.js"><link rel="prefetch" href="/social-playlist/assets/js/3.f00a2576.js"><link rel="prefetch" href="/social-playlist/assets/js/4.0cee2806.js"><link rel="prefetch" href="/social-playlist/assets/js/5.7495ea5b.js"><link rel="prefetch" href="/social-playlist/assets/js/6.ba8a17b8.js"><link rel="prefetch" href="/social-playlist/assets/js/8.140ef7cd.js"><link rel="prefetch" href="/social-playlist/assets/js/9.f8d5f274.js">
    <link rel="stylesheet" href="/social-playlist/assets/css/0.styles.a5234e6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/social-playlist/" class="home-link router-link-active"><!----> <span class="site-name">Social Playlist</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/lakermann/social-playlist" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/lakermann/social-playlist" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/social-playlist/" class="sidebar-link">Introduction</a></li><li><a href="/social-playlist/backend/first-spring-boot-application.html" class="sidebar-link">First Spring Boot application</a></li><li><a href="/social-playlist/frontend/first-angular-application.html" class="sidebar-link">First Angular Application</a></li><li><a href="/social-playlist/backend/spotify.html" class="sidebar-link">Use the Spotify API</a></li><li><a href="/social-playlist/frontend/consuming-the-rest-api.html" class="sidebar-link">Consuming the REST API</a></li><li><a href="/social-playlist/automatic-login-on-first-page-visit.html" class="active sidebar-link">Automatic login on first page visit</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/social-playlist/automatic-login-on-first-page-visit.html#backend" class="sidebar-link">Backend</a></li><li class="sidebar-sub-header"><a href="/social-playlist/automatic-login-on-first-page-visit.html#frontend" class="sidebar-link">Frontend</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="automatic-login-on-first-page-visit"><a href="#automatic-login-on-first-page-visit" aria-hidden="true" class="header-anchor">#</a> Automatic login on first page visit</h1> <p>Everytime we restart the application we have to call the <a href="https://localhost:8080/api/login" target="_blank" rel="noopener noreferrer">/api/login<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> endpoint, to set the token on the backend.
It would be better, if the user gets redirected to the login page, if the application has not received a valid token yet.
We are going to see in this chapter, how this could be done.</p> <h2 id="backend"><a href="#backend" aria-hidden="true" class="header-anchor">#</a> Backend</h2> <p>First we have to find out what happens, if the user has no token yet.
If we want to access the <a href="https://localhost:8080/api/playlists/tracks" target="_blank" rel="noopener noreferrer">/api/playlists/tracks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> endpoint without getting a token first, we receive an empty result back and in the console output of the application we can see <code>Error: Invalid access token</code>.
We can easily find out, that the error stems from the <code>try</code>/<code>catch</code>-block in the method <code>getTracksOfPlaylist</code> from the <code>SpotifyClient</code> class.</p> <p>We want to change this behaviour and instead return the status code 401, which stands for <code>UNAUTHORIZED</code>.
For this, we first create a new exception type <code>NotLoggedInException</code> and tell it with the <code>@ResponseStatus</code> annotation, that it should be mapped to the HTTP status code 401.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotLoggedInException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">NotLoggedInException</span><span class="token punctuation">(</span><span class="token class-name">UnauthorizedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;Unauthorized&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For throwing this exception, we add another <code>catch</code>-block in the <code>getTracksOfPlaylist</code>, which catches the exception from the wrapper API and maps it to the newly created <code>NotLoggedInException</code>.</p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Track</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTracksOfPlaylist</span><span class="token punctuation">(</span><span class="token class-name">String</span> playlistId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetPlaylistsTracksRequest</span> getPlaylistRequest <span class="token operator">=</span> spotifyApi<span class="token punctuation">.</span><span class="token function">getPlaylistsTracks</span><span class="token punctuation">(</span>playlistId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Paging</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PlaylistTrack</span><span class="token punctuation">&gt;</span></span> paging <span class="token operator">=</span> getPlaylistRequest<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>paging<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">PlaylistTrack</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">getTrack</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SpotifyClient</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">map</span><span class="token punctuation">)</span>g
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">UnauthorizedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotLoggedInException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">SpotifyWebApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you restart the application now and then try to access the the <a href="https://localhost:8080/api/playlists/tracks" target="_blank" rel="noopener noreferrer">/api/playlists/tracks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> endpoint you should not see the same error as before on the console and the HTTP status code of the request should be 401:</p> <p><img src="/social-playlist/assets/img/unauthorized.c28e5c46.png" alt="Unauthorized error"></p> <h2 id="frontend"><a href="#frontend" aria-hidden="true" class="header-anchor">#</a> Frontend</h2> <p>We will create an interceptor that redirects HTTP 401 API errors to the spotifiy login page.</p> <ol><li><p>Open a console terminal and issue the following command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ng generate class unauthorized-interceptor
</code></pre></div></li> <li><p>Add a redirection to the login API if an 401 error occurs.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>HttpErrorResponse<span class="token punctuation">,</span> HttpEvent<span class="token punctuation">,</span> HttpHandler<span class="token punctuation">,</span> HttpInterceptor<span class="token punctuation">,</span> HttpRequest<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Observable<span class="token punctuation">,</span> throwError<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>catchError<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UnauthorizedInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>

  <span class="token function">intercept</span><span class="token punctuation">(</span>req<span class="token punctuation">:</span> HttpRequest<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token punctuation">:</span> HttpHandler<span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">:</span> HttpErrorResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'/api/login'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">throwError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Next, we need to edit the <code>app.module.ts</code> file, so Angular uses the interceptor.</p></li></ol> <div class="language-typescript extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br></div><pre class="language-typescript"><code>providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token punctuation">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token punctuation">:</span> UnauthorizedInterceptor<span class="token punctuation">,</span> multi<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">EXERCISE</p> <ul><li>Push your changes to Heroku and test the application.</li></ul></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/social-playlist/frontend/consuming-the-rest-api.html" class="prev">
          Consuming the REST API
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/social-playlist/assets/js/app.41029deb.js" defer></script><script src="/social-playlist/assets/js/2.5ad4ca2f.js" defer></script><script src="/social-playlist/assets/js/7.1936ba72.js" defer></script>
  </body>
</html>
